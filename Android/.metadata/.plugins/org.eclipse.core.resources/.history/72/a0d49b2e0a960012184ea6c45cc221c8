package edu.hci.annoyingapp.services;

import edu.hci.annoyingapp.AnnoyingApplication;
import edu.hci.annoyingapp.activities.AnnoyingDialogActivity;
import android.app.IntentService;
import android.app.KeyguardManager;
import android.content.Context;
import android.content.Intent;
import android.os.PowerManager;
import android.util.Log;

public class AnnoyingService extends IntentService {
	
	private static final String TAG = AnnoyingService.class.getSimpleName();
	private static final boolean DEBUG_MODE = AnnoyingApplication.DEBUG_MODE;

	/**
	 * A constructor is required, and must call the super IntentService(String)
	 * constructor with a name for the worker thread.
	 */
	public AnnoyingService() {
		super(TAG);
	}

	/**
	 * The IntentService calls this method from the default worker thread with
	 * the intent that started the service. When this method returns,
	 * IntentService stops the service, as appropriate.
	 */
	@Override
	protected void onHandleIntent(Intent intent) {

		if(AnnoyingApplication.mIsDialogRunning) {
			return;
		}
		
		PowerManager pm = (PowerManager) getSystemService(Context.POWER_SERVICE);
		
		KeyguardManager kgMgr = 
			    (KeyguardManager) getSystemService(Context.KEYGUARD_SERVICE);
		boolean showing = kgMgr.inKeyguardRestrictedInputMode();
		
		if(pm.isScreenOn() && !showing) {
			Log.i("MyAwesomeService", "Launching dialog!");
			Intent intent1 = new Intent(this, AnnoyingDialogActivity.class);
			
			// This is highly deprectated...
			//intent1.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_MULTIPLE_TASK);
			
			// This works only after api 11...
			intent1.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);
			startActivity(intent1);
		} else {
			Log.i("MyAwesomeService", "Screen is off or locked...");
		}

	}
}
